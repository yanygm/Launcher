using System.Text;
using KartLibrary.File;
using KartLibrary.IO;

namespace KartLibrary.Encrypt;

public static class RhoKey
{
    private static uint[,] EncryptVectors = new uint[4, 256]
    {
        {
            698093334u, 4153209025u, 687329636u, 1330254401u, 3916106625u, 2952421312u, 4104853545u, 342297114u, 3849582276u, 594759519u,
            3972706581u, 3813314319u, 2546473586u, 2745643552u, 15292858u, 359052952u, 2648217043u, 2296540034u, 650215534u, 480030859u,
            3486473202u, 3251391348u, 2341285349u, 1648238562u, 957865264u, 230415491u, 1176551027u, 1334224241u, 2049672829u, 963654108u,
            1832923131u, 418379265u, 302181290u, 2837768150u, 3919102800u, 2472387261u, 2408932129u, 2834486529u, 722309581u, 385394533u,
            3323963752u, 374371742u, 2865252492u, 3395534059u, 3903329902u, 1562257198u, 1353058821u, 570194068u, 2744804230u, 3455760427u,
            1950516124u, 3076488623u, 3621414904u, 2324290484u, 3207667468u, 2814379519u, 2098869167u, 1790116637u, 2313721741u, 1460238820u,
            104826264u, 4173353579u, 2177892388u, 1745874687u, 3847153305u, 2341433717u, 951194773u, 1015501097u, 1769704939u, 3626945938u,
            358472393u, 3109202619u, 2532315582u, 3258639444u, 3115954683u, 3921353904u, 2909718235u, 3533454938u, 1414711068u, 2634845840u,
            3824536475u, 4006059241u, 36821267u, 1292660696u, 509272341u, 2760497346u, 1583957758u, 3763309577u, 493123696u, 780592180u,
            176468239u, 1329032349u, 3609623374u, 734956914u, 1884483001u, 1177920190u, 198346963u, 3626028797u, 1282987909u, 1641518430u,
            868662499u, 1388019710u, 2344259898u, 2518152987u, 3916586844u, 1485854782u, 1997748114u, 799065594u, 2799018585u, 3891712019u,
            3819786570u, 887420462u, 1420945805u, 910348539u, 1890029406u, 1779941450u, 126246865u, 1290609213u, 2556250476u, 156001151u,
            2618976178u, 3766583560u, 1323932496u, 2101678106u, 2307583117u, 2021169506u, 2104181638u, 1864171331u, 1206350966u, 139129898u,
            1872868344u, 2602529641u, 4274744181u, 284774378u, 3234054152u, 1730996481u, 3558114334u, 801198866u, 2065285037u, 3182757731u,
            1058244612u, 2704875913u, 695465041u, 4077033321u, 4239835338u, 1126647744u, 752344413u, 822587063u, 770824953u, 3313411895u,
            1011835720u, 1128115455u, 495577493u, 2598725063u, 4071514793u, 3851300108u, 3163875426u, 872884951u, 3493678917u, 1189654272u,
            1382382869u, 35866067u, 1493582674u, 2013883806u, 2289110932u, 4231654554u, 2676790928u, 701574000u, 694761963u, 3388570500u,
            2075481424u, 1503005344u, 3457051327u, 2849643141u, 2682410156u, 3160380198u, 4176311402u, 3586855186u, 596127797u, 2408536078u,
            3338706890u, 3989491476u, 1000005130u, 267726788u, 2606490709u, 2079562148u, 990133887u, 4212047548u, 372683482u, 423565605u,
            4206110512u, 1641385630u, 793718707u, 2276852007u, 145338824u, 3165673658u, 2246298937u, 3598720248u, 1515210630u, 50058982u,
            2213611256u, 2142834679u, 4087169429u, 535429941u, 3734488325u, 2049992511u, 711205354u, 1895190464u, 2363464887u, 1142307627u,
            111212467u, 3559250549u, 549102225u, 4220213057u, 1819020928u, 1197987170u, 2978395763u, 3348576983u, 870349943u, 3568139464u,
            1655437981u, 1088058025u, 1268784554u, 1465089546u, 2241055893u, 649004453u, 2940211790u, 2408521248u, 19048566u, 3682791466u,
            799394750u, 2241560215u, 1369583909u, 2115672880u, 2012277295u, 3690353539u, 1798238871u, 3850134856u, 1129720966u, 3831433044u,
            1762436592u, 1750126651u, 2060909029u, 2320376527u, 2066296945u, 2566062569u, 1932566005u, 3711313010u, 2589552103u, 1048331752u,
            1485675962u, 3335205308u, 852831296u, 673510280u, 582893437u, 2886556496u
        },
        {
            4181631060u, 47417776u, 1757478942u, 3817329965u, 1560940818u, 3142495404u, 2508309135u, 2967432282u, 1386236851u, 3794408196u,
            3429053971u, 5996427u, 3925920555u, 2480383980u, 2272005648u, 3146488764u, 341456675u, 1104227971u, 2326084750u, 2766999750u,
            1443444869u, 2264555454u, 881431276u, 3163419123u, 2547672739u, 2201076626u, 505695535u, 3829505432u, 666893565u, 2209185137u,
            437411811u, 334690526u, 645413089u, 2322840079u, 3523063969u, 4150953035u, 1535639299u, 2950597294u, 825807068u, 396195771u,
            1201932454u, 3165595645u, 1934031957u, 3015587333u, 2776513451u, 1444292422u, 1874510995u, 734521941u, 2777702029u, 4206164477u,
            1124817702u, 4049963616u, 4095694648u, 744741431u, 2184245910u, 633910251u, 2342946596u, 2267197151u, 4285150696u, 3168148534u,
            3152646560u, 2569762923u, 2272146211u, 3856254697u, 3471723864u, 2931431626u, 999085810u, 2922252747u, 1086226044u, 31305698u,
            118025945u, 430895621u, 1886065097u, 2211614154u, 3072713206u, 1795644849u, 1198469185u, 1860538734u, 2175555335u, 3973841469u,
            3223652521u, 473450783u, 2767753397u, 3247635055u, 3700221316u, 2109341973u, 1447642835u, 3095191104u, 1994681836u, 4049865719u,
            362914443u, 3768656669u, 3307941798u, 1653498822u, 3271011717u, 2278175336u, 3272256157u, 367874350u, 1982105250u, 3974887957u,
            1252597193u, 2446058114u, 519755358u, 2769213634u, 194604088u, 1897069666u, 3949494183u, 2444689095u, 822224930u, 2693077371u,
            674502832u, 1682824772u, 4184773274u, 786268422u, 2120371978u, 2939165824u, 300329374u, 1280086517u, 1903706390u, 2136877956u,
            1751803107u, 3450272911u, 1394539891u, 2015821016u, 918729577u, 3270067250u, 1282665859u, 3809619628u, 2825798977u, 2799334771u,
            3810947720u, 1696932716u, 2244729217u, 1768922263u, 3247762661u, 4272827329u, 3448264938u, 3351053890u, 43200102u, 1427094919u,
            3774216897u, 2816185752u, 1297573767u, 1907383725u, 2081786939u, 1606016604u, 3735683300u, 1853931798u, 3631212503u, 2331110477u,
            594705877u, 1446954294u, 848740229u, 164523662u, 1522372080u, 1798222740u, 1781497146u, 3681115413u, 1363115473u, 1189715765u,
            582758679u, 326337290u, 2889091778u, 3756669154u, 2006538245u, 1902252616u, 1531366426u, 3800550998u, 1621036151u, 1021672012u,
            2475442978u, 826923317u, 4105006746u, 3840995050u, 2625635870u, 607328449u, 1063980086u, 3835404277u, 2064790403u, 1911651972u,
            2627193251u, 3921064175u, 3132359406u, 2812930290u, 3861077646u, 769003807u, 2445902431u, 384710439u, 2280055772u, 1129519812u,
            1714457423u, 3820394937u, 3207023353u, 2599497051u, 825560403u, 3913538171u, 3894846137u, 3006821722u, 434854984u, 364402715u,
            2570203150u, 2811331519u, 640878u, 3872849084u, 2858460161u, 2840641518u, 3456548872u, 3211901691u, 405033398u, 3182943871u,
            4244371226u, 2922610770u, 1411339617u, 1479544314u, 4171485374u, 86316091u, 3392929540u, 2190062385u, 1080764032u, 3196137586u,
            3048652908u, 4109807017u, 1025450618u, 1814731735u, 2490825851u, 2864863526u, 1163884565u, 1595281213u, 3408331195u, 615364325u,
            2766655976u, 3142192623u, 3092705583u, 4206570809u, 461473125u, 3557859314u, 2845124748u, 318211766u, 326698961u, 1848963278u,
            3817411904u, 4188264546u, 3294893021u, 1157463794u, 21830237u, 2068286196u, 3559314781u, 844924981u, 3794806926u, 2139348922u,
            2039725338u, 1021549835u, 2967854946u, 4251893843u, 1460143923u, 3698525709u
        },
        {
            68991385u, 526532244u, 2526318983u, 4074936836u, 251318069u, 1393743729u, 1213090431u, 1962883870u, 2073281660u, 2682625237u,
            2235658529u, 4291542149u, 3298009539u, 4137377780u, 2680857763u, 2577504365u, 2585658712u, 391104297u, 2860780138u, 1179567361u,
            4250018237u, 307477156u, 1488846456u, 910898745u, 2753591204u, 2514269486u, 3161027602u, 3104588120u, 549159283u, 3891196712u,
            1410668323u, 2093180971u, 2343253148u, 927759012u, 3825480377u, 3617006263u, 3942796895u, 4213216620u, 1822726507u, 3155048427u,
            4066669120u, 2219659600u, 2641066393u, 673263335u, 3441424756u, 440135943u, 2078609390u, 3931410312u, 277672005u, 3641402857u,
            1110393974u, 3325539497u, 2397308820u, 3983697196u, 3728352220u, 4024867822u, 1736398658u, 1599401014u, 976690026u, 754948884u,
            1228108660u, 3126605887u, 95371938u, 836108259u, 4168271218u, 2459723282u, 2528907725u, 875534369u, 2727265841u, 1853338728u,
            4038165811u, 349439548u, 2389574882u, 512764798u, 937322611u, 1543801902u, 2427122692u, 909087755u, 3148928503u, 2200268920u,
            3432855689u, 2954292601u, 4293214560u, 1905607796u, 3591390404u, 247160569u, 1624205075u, 3167094051u, 2997125540u, 4005802553u,
            2102618041u, 2688308532u, 929360733u, 837895476u, 1464234355u, 37995600u, 2515936024u, 790856770u, 157537748u, 3850540500u,
            1198511997u, 1590184104u, 1964793294u, 1511928049u, 931198746u, 3876716866u, 3891455874u, 2615234684u, 2547996750u, 2740135445u,
            916308950u, 2106519051u, 1607065799u, 4239422779u, 4011433041u, 2688080119u, 311489827u, 379888127u, 2069223186u, 3372145743u,
            2212097256u, 1230490834u, 3323909079u, 609471807u, 57507715u, 3811272393u, 174926372u, 69329168u, 1028147823u, 1990482464u,
            2811419979u, 4242306510u, 750987694u, 1223511117u, 1774953207u, 114864146u, 963845191u, 2562995518u, 2208405464u, 1348981207u,
            1352474349u, 1638957415u, 3984014733u, 3275831710u, 3462056116u, 1484310779u, 1246087621u, 942330471u, 121096981u, 1868452956u,
            3047725046u, 1153013590u, 3540968300u, 1431065733u, 2862059718u, 2617894010u, 1736971326u, 1252958033u, 2220667690u, 1722522016u,
            2386550172u, 1298937087u, 3372373633u, 1783891268u, 3848361770u, 2030640771u, 3778719649u, 2011505422u, 1853074758u, 2080868333u,
            521038421u, 3970747141u, 2615778500u, 1983615056u, 3160406701u, 1772280874u, 3356394712u, 393997452u, 2551703327u, 3561577947u,
            1113742532u, 1094688954u, 1378525983u, 4079289191u, 769445801u, 4059395191u, 2923319299u, 1607643742u, 990477363u, 3553036582u,
            19420232u, 438911287u, 1922809389u, 2382247967u, 1131973675u, 2447644212u, 2237984830u, 3928291769u, 583145762u, 3779453227u,
            1214070317u, 2405201572u, 406014545u, 3624288373u, 2399469442u, 787894266u, 425104857u, 4076527394u, 3091248323u, 424423682u,
            25717394u, 3552275240u, 1358496527u, 2347694319u, 3025052140u, 672221337u, 2896010857u, 1183664959u, 438878076u, 2499608325u,
            654302346u, 271149415u, 2100585754u, 1558684028u, 1638807023u, 2782673210u, 839562881u, 2586973977u, 1568198025u, 1153045026u,
            3698876939u, 187521307u, 1007689615u, 4291325204u, 4187191288u, 3021132085u, 1328145094u, 949257115u, 3710627609u, 1205521749u,
            1766851989u, 2619541479u, 721975080u, 2550886472u, 3994055474u, 2016147303u, 895350931u, 1049310824u, 791827290u, 1653055102u,
            3483864298u, 3877078855u, 3318905331u, 3630152715u, 3239148266u, 3232357104u
        },
        {
            990685351u, 3817408038u, 2780417155u, 3648157507u, 1676167516u, 636118092u, 1345440942u, 3368027300u, 3953004261u, 2270839896u,
            359779047u, 2850759413u, 3315972108u, 3422906710u, 558406616u, 4131400947u, 4263647690u, 4002025643u, 1309038711u, 3414891590u,
            1354587019u, 3100014252u, 2672459854u, 963694860u, 47972109u, 1172263679u, 1640169200u, 642429312u, 3295692143u, 823954549u,
            2305637600u, 844822004u, 336176240u, 1283095007u, 3336465230u, 2192263565u, 508720502u, 871611436u, 4234909339u, 478709248u,
            3751833154u, 2893032882u, 3346661374u, 1038683449u, 3978114023u, 2636629938u, 2472697484u, 2786295597u, 695904887u, 3627327837u,
            206457334u, 3138154682u, 252348829u, 3285063913u, 1787004349u, 3664962836u, 2096085483u, 2680314657u, 1998444182u, 3890604637u,
            3027011700u, 688113102u, 3832533232u, 1998307394u, 2052034208u, 2732583009u, 246067737u, 3406697528u, 2610787122u, 3379245347u,
            4098905775u, 2467991394u, 2183659936u, 2424894264u, 2825504946u, 3054114303u, 4187965439u, 3148243257u, 1876982515u, 2906880567u,
            1905349969u, 3761535704u, 628000093u, 1150642730u, 2261330672u, 1424248583u, 1881125930u, 1518147151u, 96576077u, 3397271058u,
            2691286880u, 2119469696u, 113598694u, 2265489628u, 842872568u, 26506517u, 3989912137u, 816887151u, 935275155u, 2867027776u,
            709135393u, 421512668u, 187890863u, 2666027315u, 2592647480u, 749947710u, 4208457976u, 475158715u, 2505868283u, 2853035673u,
            3238562268u, 3167671155u, 4199949961u, 2901741559u, 430469014u, 1111033302u, 3080557286u, 1162992787u, 1611138389u, 2503088125u,
            2447918889u, 2121730776u, 3576168699u, 3689061689u, 3164621491u, 2474572562u, 3302613200u, 3994510645u, 3004322070u, 3737125728u,
            1962539738u, 1532881795u, 3703348860u, 3486732989u, 2374368669u, 3906017615u, 3159095837u, 2504222223u, 393343441u, 465021017u,
            3950776795u, 481112752u, 2521086986u, 153181479u, 3973228140u, 2125035161u, 1006582964u, 3658161059u, 2151600959u, 1157176317u,
            1490505098u, 1455201450u, 3850615380u, 293113271u, 3177834718u, 2104998164u, 2378059596u, 1199976697u, 2418659320u, 2319490534u,
            1882425632u, 3959669986u, 1432208920u, 3535095632u, 132044585u, 3859190770u, 1669095567u, 178923337u, 4292879320u, 496484520u,
            2129654366u, 1372675872u, 2750192147u, 3275326295u, 2866176260u, 455185505u, 4151564543u, 2635181000u, 1754955986u, 2397627325u,
            2314054272u, 2651383093u, 2166381700u, 407807836u, 2507289246u, 2499309535u, 1832927250u, 238545439u, 2383658931u, 2192777044u,
            3468288829u, 1422860145u, 2825934462u, 3556887835u, 1698297278u, 271542445u, 3461268938u, 299818910u, 2682218376u, 2555098616u,
            3474409209u, 3835673796u, 1090001123u, 2423653801u, 855462623u, 2309279076u, 1864782611u, 3262722074u, 1791105955u, 3567238470u,
            1124811847u, 765645313u, 4085506910u, 2514568779u, 1756579969u, 3168186558u, 269890522u, 2537278472u, 4230874910u, 2611737342u,
            2991866954u, 4162164733u, 3690817971u, 1121028542u, 2279913558u, 3065780578u, 2684468532u, 153544813u, 1995397060u, 3266151985u,
            231400673u, 2996305904u, 2558005572u, 4059982330u, 3672748954u, 1896422142u, 2123631560u, 2025179922u, 1612621306u, 3127892520u,
            2364308393u, 3902219752u, 1484347347u, 2637366522u, 193980768u, 2763262726u, 3795679521u, 1377885408u, 92204739u, 1160561528u,
            2228376594u, 3547852830u, 3508065379u, 4118642277u, 4291283439u, 3342538584u
        }
    };

    public static uint GetRhoKey(string FileName)
    {
        byte[] bytes = Encoding.GetEncoding("UTF-16").GetBytes(FileName);
        return Adler.Adler32(0u, bytes, 0, bytes.Length) - 2800645477u;
    }

    public static uint GetJmdKey(string FileName)
    {
        byte[] bytes = Encoding.GetEncoding("UTF-16").GetBytes(FileName);
        return Adler.Adler32(0u, bytes, 0, bytes.Length) + 1038683587;
    }

    public static uint GetBlockFirstKey(uint RhoKey)
    {
        return RhoKey ^ 0x3A9213ACu;
    }

    public static uint GetDirectoryDataKey(uint RhoKey)
    {
        return RhoKey + 630434289;
    }

    public static uint GetJmdDirectoryDataKey(uint RhoKey)
    {
        return RhoKey - 1090604735;
    }

    public static uint GetDataKey(uint RhoKey, RhoFileInfo fileInfo)
    {
        byte[] bytes = Encoding.GetEncoding("UTF-16").GetBytes(fileInfo.Name);
        return (uint)((int)Adler.Adler32(0u, bytes, 0, bytes.Length) + fileInfo.ExtNum) + (RhoKey - 1970136660);
    }

    public static uint GetFileKey(uint RhoKey, string fileName, uint extNum)
    {
        byte[] bytes = Encoding.GetEncoding("UTF-16").GetBytes(fileName);
        return Adler.Adler32(0u, bytes, 0, bytes.Length) + extNum + (RhoKey - 1970136660);
    }

    public static uint GetJmdDataKey(uint RhoKey, RhoFileInfo fileInfo)
    {
        byte[] bytes = Encoding.GetEncoding("UTF-16").GetBytes(fileInfo.Name);
        return (uint)((int)Adler.Adler32(0u, bytes, 0, bytes.Length) + fileInfo.ExtNum) + (RhoKey - 2116743997);
    }

    public unsafe static byte[] ExtendKey(uint originalKey)
    {
        byte[] array = new byte[64];
        fixed (byte* ptr = array)
        {
            uint* ptr2 = (uint*)ptr;
            uint num = originalKey ^ 0x8473FBC1u;
            for (int i = 0; i < 16; i++)
            {
                ptr2[i] = num;
                num -= 2072773695;
            }
        }

        return array;
    }

    public static uint GetVector(uint value)
    {
        uint num = 0u;
        for (int i = 0; i < 4; i++)
        {
            num ^= EncryptVectors[i, (value >> (i << 3)) & 0xFF];
        }

        return num;
    }

    public static byte[] getKey(string filename, string anotherData)
    {
        filename = filename.ToLower();
        string s = filename + anotherData;
        byte[] bytes = Encoding.GetEncoding("UTF-16").GetBytes(s);
        byte[] array = new byte[128];
        int num = bytes.Length >> 1;
        for (int i = 0; i < 128; i++)
        {
            int num2 = i % num;
            array[i] = (byte)(bytes[num2 * 2] + i);
        }

        return array;
    }
}